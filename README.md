# TweenLib

## Introduction

**TweenLib** is a tweening library for Unity ECS that enables field-level tweening of `IComponentData`.

## Installation

To install, paste the following URL into Unity's **Package Manager**:

1. Open **Package Manager**.
2. Click the **+** button.
3. Select **"Add package from git URL..."**.
4. Enter the following URL:

```bash
https://github.com/hoangtongvu/TweenLib.git?path=/Assets/TweenLib
```

## Documentation

- [Sample scene and see tweens in action](Assets/TweenLib/Documentation~/see-tweens-in-action.md)
- [How it works](Assets/TweenLib/Documentation~/how-it-works.md)

## How to use

See [how-to-use-shake-tween](Assets/TweenLib/Documentation~/how-to-use-shake-tween.md) for Shake tween case.

### 1. Use predefined Tweener or declare your own

TweenLib provides several ready-to-use Tweeners in the [StandardTweeners](Assets/TweenLib/StandardTweeners) assembly:
- [TransformPositionTweener](Assets/TweenLib/StandardTweeners/TransformPositionTweener.cs)
- [TransformRotationTweener](Assets/TweenLib/StandardTweeners/TransformRotationTweener.cs)
- [ShakePositionTweener](Assets/TweenLib/StandardTweeners/ShakePositionTweeners/ShakePositionTweener.cs)
- [ShakePositionXTweener](Assets/TweenLib/StandardTweeners/ShakePositionTweeners/ShakePositionXTweener.cs)
- [ShakePositionXYTweener](Assets/TweenLib/StandardTweeners/ShakePositionTweeners/ShakePositionXYTweener.cs)
- [ShakePositionXZTweener](Assets/TweenLib/StandardTweeners/ShakePositionTweeners/ShakePositionXZTweener.cs)
- *(More coming soon...)*

Or, you can create your own Tweener with custom logic:
- The Tweener must be **partial struct**.
- The Tweener must implement `ITweener<Component, Target>`, where:
    - `Component` is the `IComponentData` that you want to tween on.
    - `Target` is the tween target value.
    - Defining a Tweener means specifying which fields in the Component will be tweened.
- The Tweener must define the following methods:
    - `GetDefaultStartValue()`: Define `defaultStartValue` in case you don't want to use custom `startValue`.
    - `GetSum()` and `GetDifference()`: Used when your Tween Looping Type is `LoopingType.Incremental`.
    - `Tween()`: This is main tween method.
- The Tweener must be created inside an assembly that has assembly definition references like ones in [TweenLib.StandardTweeners.asmdef](Assets/TweenLib/StandardTweeners/TweenLib.StandardTweeners.asmdef)

**A Tweener example** ([TransformPositionTweener](Assets/TweenLib/StandardTweeners/TransformPositionTweener.cs)):
```cs
[BurstCompile]
public partial struct TransformPositionTweener : ITweener<LocalTransform, float3>
{
    [BurstCompile]
    public void GetDefaultStartValue(in LocalTransform componentData, out float3 defaultStartValue)
        => defaultStartValue = componentData.Position;

    [BurstCompile]
    public void GetSum(in float3 a, in float3 b, out float3 result)
        => result = a + b;

    [BurstCompile]
    public void GetDifference(in float3 a, in float3 b, out float3 result)
        => result = a - b;

    [BurstCompile]
    public void Tween(ref LocalTransform componentData, in float normalizedTime, EasingType easingType, in float3 startValue, in float3 target)
    {
        TweenHelper.Float3Tween(in normalizedTime, easingType, in startValue, in target, out componentData.Position);
    }
}
```

[TweenHelper](Assets/TweenLib/Utilities/Helpers/TweenHelper.cs) supports fast-to-use tween helper methods:
- FloatTween()
- Float2Tween()
- Float3Tween()
- Float4Tween()

### 2. Attach generated components to your entities

There are 2 components generated by source generator, named based on your Tweener name.
- `{tweenerName}_TweenData`
- `Can_{tweenerName}_TweenTag`

You can attach them manually or use only a generated method `{TweenerName}.AddTweenComponents(baker, entity);`

**CubeAuthoring example:**
```cs
public class CubeAuthoring : MonoBehaviour
{
    private class Baker : Baker<CubeAuthoring>
    {
        public override void Bake(CubeAuthoring authoring)
        {
            Entity entity = GetEntity(authoring, TransformUsageFlags.Dynamic);

            TransformPositionTweener.AddTweenComponents(this, entity);

            // The below code is the manual version of the previous one
            // AddComponent<Can_TransformPositionTweener_TweenTag>(entity);
            // SetComponentEnabled<Can_TransformPositionTweener_TweenTag>(entity, false);
            // AddComponent<TransformPositionTweener_TweenData>(entity);
        }
    }
}
```

### 3. Use `TweenBuilder` to create your tween

To trigger tweening, use `TweenBuilder` in your systems, which can be accessed via `Tweener`.

`TweenBuilder` APIs:

- `Create()` and `Build()` (**Required**)
- `WithXXX()` (**Optional**):
    - `WithStartValue()`: Specify the custom start value for the tween.
    - `WithEase()`: Specify easing type for the tween, default value is `EasingType.Linear`.
    - `WithLoops(LoopType loopType, byte loopCount = byte.MinValue)`: Specify `LoopType` and `loopCount`, `loopCount == 0` means infinite loop. Since the `loopCount` is byte, its value can't exceed 255.
    - `WithDelay()`: Specify delay seconds before the tween start.

**A TweenBuilder usage example:**
```cs
foreach (var (transformRef, canTweenTag, tweenDataRef) in
    SystemAPI.Query<
        RefRO<LocalTransform>
        , EnabledRefRW<Can_TransformPositionTweener_TweenTag>
        , RefRW<TransformPositionTweener_TweenData>>()
        .WithOptions(EntityQueryOptions.IgnoreComponentEnabledState))
{
    TransformPositionTweener.TweenBuilder
        .Create(0.8f, new float3(3f, 0f, 0f))
        .WithStartValue(new float3(-3f, 0f, 0f))
        .WithEase(EasingType.Linear)
        .WithLoops(LoopType.Yoyo, 2)
        .WithDelay(0.2f);
        .Build(ref tweenDataRef.ValueRW, canTweenTag);
}
```

See [EasingType](Assets/TweenLib/Utilities/EasingUtilities.cs) in EasingUtilities.cs to see all supported Easing Types.

See [LoopType](Assets/TweenLib/Commons/LoopType.cs) to see all supported Looping Types.

## Word of caution

Avoid using multiple Tweeners to tween **the same fields** on a component **at the same time**. Since Tweeners operate independently, the last tween system to update will overwrite the changes made by the previous ones, potentially causing unexpected results.

## Known issues

- **Multiple Interface Implementation:** If a Tweener implements multiple interfaces and ITweener is not the first one listed, the source generator may not work correctly.
